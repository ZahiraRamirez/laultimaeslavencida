// (el cÃ³digo anterior permanece igual hasta el final del array 'materias')
    ];

    const estado = JSON.parse(localStorage.getItem('estadoMaterias') || '{}');

    function cumpleCorrelativas(m) {
      return m.correl.every(c => estado[c] && estado[c] >= 4);
    }

    function calcularPromedio() {
      const notas = Object.values(estado).filter(n => n >= 4);
      const promedio = notas.length ? (notas.reduce((a,b) => a + b) / notas.length).toFixed(2) : '-';
      document.getElementById('promedio').textContent = promedio;
    }

    function render() {
      const contenedor = document.getElementById('malla');
      contenedor.innerHTML = '';
      const grupos = {};
      materias.forEach(m => {
        const key = `${m.anio}Â° AÃ±o - ${m.cuatri}Â° Cuatrimestre`;
        if (!grupos[key]) grupos[key] = [];
        grupos[key].push(m);
      });

      Object.entries(grupos).forEach(([titulo, lista], i) => {
        const div = document.createElement('div');
        div.className = 'bloque';
        div.innerHTML = `<h2>${titulo}</h2>`;
        lista.forEach(m => {
          const nota = estado[m.cod] ?? '';
          const aprobada = nota >= 4;
          const habilitada = cumpleCorrelativas(m);
          const materia = document.createElement('div');
          materia.className = 'materia';
          if (aprobada) materia.classList.add('aprobada');
          if (!habilitada && !aprobada) materia.classList.add('bloqueada');
          materia.style.background = coloresPastel[i % coloresPastel.length];

          const label = document.createElement('span');
          label.textContent = `${m.nombre}${aprobada ? ' ðŸŒ¸' : ''}`;

          const input = document.createElement('input');
          input.className = 'nota-input';
          input.type = 'number';
          input.min = 1;
          input.max = 10;
          input.value = nota;
          input.disabled = !habilitada && !aprobada;
          input.onchange = () => {
            const val = parseInt(input.value);
            if (val >= 1 && val <= 10) {
              estado[m.cod] = val;
              localStorage.setItem('estadoMaterias', JSON.stringify(estado));
              render();
              calcularPromedio();
            }
          };

          if (!habilitada && !aprobada) {
            const tooltip = document.createElement('span');
            tooltip.className = 'tooltip';
            tooltip.textContent = 'Faltan: ' + m.correl.map(c => materias.find(x => x.cod === c)?.nombre).join(', ');
            materia.appendChild(tooltip);
          }

          materia.appendChild(label);
          materia.appendChild(input);
          div.appendChild(materia);
        });
        contenedor.appendChild(div);
      });

      calcularPromedio();
    }

    render();
  </script>
</body>
</html>
